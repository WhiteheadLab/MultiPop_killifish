---
title: "Salmon fmd to DEG analysis of F. grandis embryos"
output: 
  html_notebook: 
    fig_caption: yes
    toc: yes
  html_document: 
    keep_md: yes
    toc: yes
editor_options: 
  chunk_output_type: console
---

2018 January 31

Jane Park

## Libraries

```{r libraries}
library(readxl)
library(tximportData)
library(tximport)
library("lattice")
library(biomaRt)
library(readr)
library(gplots)
library(RColorBrewer)
library(edgeR)
library(limma)
library(tidyr)
library(dplyr)
library(data.table)

source("~/Documents/NIEHS_LSU_UCD/scripts/fun_TreatNames_all.R")
source("~/Documents/NIEHS_LSU_UCD/scripts/fun_TreatNames_sub.R")
source("~/Documents/NIEHS_LSU_UCD/scripts/fun_MeanVar_all.R")
source("~/Documents/NIEHS_LSU_UCD/scripts/fun_TreatMeans.R")

setwd("~/Documents/NIEHS_LSU_UCD/rnaseq/")

```


## Import quantification tables 

Name quantification files path: 
```{r}
dir <- "~/Documents/NIEHS_LSU_UCD/rnaseq/180123_kfishind_fmd_salmcounts/"
files_list <- list.files(dir)
files <- file.path(dir,files_list, "quant.sf")
all(file.exists(files))
names <- gsub("_quant", "", files_list)
names(files) <- names
```

## Associate transcripts to gene IDs 

I'm using the gene model annotation file from supplementary materials of Noah Reid's 2016 paper, ["The genomic landscape of rapid repeated evolutionary adaptation to toxic pollution in wild fish"](http://science.sciencemag.org/content/suppl/2016/12/07/354.6317.1305.DC1)

Subset the appropriate columns from the above table. 

"We first make a data.frame called tx2gene with two columns: 1) transcript ID and 2) gene ID. The column names do not matter but this column order must be used. The transcript ID must be the same one used in the abundance files.""
```{r}
gene_names <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Fhet_gene_transcript_names.csv")
cols <- c("row", "transcript_id", "gene_id")
colnames(gene_names) <- cols
tx2gene <- gene_names[,2:3]
head(tx2gene)
```


## Convert transcript-level counts to gene-level counts, and save as a DGEList object for easy handling. Counts are scaled for library size.
txi$abundance is the TPM table for gene-level estimates. txi$counts is the counts normalized for transcript lengths. 

```{r}
txi <- tximport(files, type="salmon", tx2gene=tx2gene, countsFromAbundance = "lengthScaledTPM")
names(txi)
head(txi$counts)
```

```{r}
y <- DGEList(txi$counts)
head(y$samples)

samplenames <- colnames(y$counts)

parenttreat <- substring(samplenames, 8, 8)
parenttreat <- as.factor(c(parenttreat))
y$samples$group <- parenttreat

exposure <- substring(samplenames, 9,10)
exposure <- as.factor(c(exposure))
y$samples$exposure <- exposure

stage <- substring(samplenames, 11, 12)
stage <- as.factor(c(stage))
y$samples$stage <- stage

y$samples$trt <- with(y$samples, paste(group, stage, exposure, sep="."))
```


## Subsetting and filtration

First, exclude Hatch, NonHatch, and Stage 19 56% [WAF] Replicate # 4 and 5 (outlier) samples, and extra Stage 19 Control embryo: 
```{r}
y <- y[,y$samples$stage!="HA" & y$samples$stage!="NH"]
samex <- which(colnames(y$counts) == "0130ARSE56195")
samex2 <- which(colnames(y$counts) == "0129ARSE56194")
samex3 <- which(colnames(y$counts) == "0176ARSC00196") 
samx <- c(samex, samex2, samex3)
y <- y[, as.vector(-samx)]

#Save unfiltered, untransformed data as another object: 
zz <- y	

```


### Filter out lowly expressed reads

Filter all samples based on counts greater than 5 in at least 4 replicate samples of 1 treatment group: 

```{r}
#Create a list of genes for which there are greater than 5 counts in at least 4 replicates for each treatment group: 
d = list()
treat <- unique(y$samples$trt)
head(treat)

for (i in 1:length(treat)) {
	a <- which(y$samples$trt==treat[i])
	b <- colnames(y$counts[,a])
	kp <- rowSums(y$counts[,a] > 5) >=4 
	g <- which(kp==TRUE)
	d[[i]] <- g
}

#Subset the DGEList object y by the gene list created above:
nrow(y$counts)
filt_genes <- unique(names(unlist(d, use.names=TRUE)))
length(filt_genes)
y <- y[filt_genes,]
nrow(y$counts)

#Save filtered background gene list:
write.table(filt_genes, file="~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180322_backgroundlist.csv",
	col.names=FALSE, row.names=FALSE, sep="\t")
```


## Normalize and Log Transform Read Counts

Optimal constant is 6:

```{r}
#Transform count + constant: 
trans <- log2(y$counts+8)
```

#### Visualize mean-variance trend: 
```{r}
#Calculate mean and variance for each gene for every treatment group (mean gene expression for every unique treatment, e.g. C.35.00)
ttrans <- t(trans)
ttrans <- as.data.frame(ttrans)
ttrans <- TreatNames_sub(ttrans)
mv <- MeanVar(ttrans)
mea <- as.vector(mv$mean)
sd <- as.vector(mv$stdev)

#Calculate slope of regression between mean and standard deviation
slope <- (coef(lm(sd~mea))[2])
print(slope)

#Plot mean and standard deviation relationship with lowess line and slope of the regression
pdf('~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180206_countlog+8.pdf')
plot(mea,sd, pch=16, cex=0.5, main="Mean-SD relationship of Log(counts + 8), slope=-0.001155113")
abline(coef(lm(sd~mea)),col="red",lwd=3)
lines(lowess(mea,sd,f=0.001),col="blue",lwd=3)
dev.off()

```


#### Normalize log-transformed counts for all samples: 

```{r}
mean_counts <- colMeans(trans)
norm_counts <- sweep(trans, 2, colMeans(trans))
grandmean <- mean(mean_counts)
norm_counts <- norm_counts + grandmean
y$counts <- norm_counts
```

Visualize mean-variance relationship after normalization for the whole data set: 

```{r}
#Calculate and visualize mean and standard deviation of each gene for every treatment after normalization, whole data set: 
ttrans <- t(norm_counts)
ttrans <- as.data.frame(ttrans)
ttrans <- TreatNames_sub(ttrans)
mv <- MeanVar(ttrans)
mea <- as.vector(mv$mean)
sd <- as.vector(mv$stdev)
slope <- (coef(lm(sd~mea))[2])
print(slope)

#Plot the mean and standard deviation relationship after normalization of the whole data set: 
pdf('~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180322_normcountslog+8.pdf')
plot(mea,sd, pch=16, cex=0.5, main="Mean-SD relationship of Normalized Log(counts + 8), slope=-.033")
abline(coef(lm(sd~mea)),col="red",lwd=3)
lines(lowess(mea,sd,f=0.2),col="blue",lwd=3)
dev.off()

ttrans <- t(StageData$lat$counts)
ttrans <- as.data.frame(ttrans)
ttrans <- TreatNames_sub(ttrans)
mv <- MeanVar(ttrans)
mea <- as.vector(mv$mean)
sd <- as.vector(mv$stdev)
slope <- (coef(lm(sd~mea))[2])
print(slope)
```


## Unsupervised clustering of Data/ MDS plot:

```{r}
# MDS Plot
par(mfrow=c(1,1))
group <- y$samples$group
stage <- y$samples$stage
treats <- y$samples$trt
exp <- y$samples$exposure

col.group <- as.factor(group)
levels(col.group) <-  brewer.pal(nlevels(col.group), "Dark2")
col.group <- as.character(col.group)

col.exp <- as.factor(exp)
levels(col.exp) <- brewer.pal(nlevels(col.exp), "Dark2")
col.exp <- as.character(col.exp)

col.stage <- as.factor(stage)
levels(col.stage) <- brewer.pal(nlevels(col.stage), "Dark2")
col.stage <- as.character(col.stage)

col.treat <- as.factor(treats)
levels(col.treat) <- brewer.pal(nlevels(col.treat), "Set1")
col.treat <- as.character(col.treat)

plotMDS(y, labels=treats, col=col.stage, dim=c(1,2))
```

## Save all log-transformed & normalized counts and sample information for whole data set and subsets: 

```{r}
#Normalized counts and samples for whole data set: 
write.table(y$counts, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180322_allstages_no_outlier_normcounts_noouts.csv", 
		col.names=TRUE, row.names=TRUE, sep=",")
write.table(y$samples, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180205_allstages_no_outlier_samplesinfo_noouts.csv", 
            col.names=TRUE, row.names=TRUE, sep=",")

```

## All-stages DEG Analysis

```{r}
for (j in 1:ncol(stages.dge[[i]][,1:d])) {
    g <- which(rownames(pdat.stages[[i]])==colnames(stages.dge[[i]])[j])
    l <- lm(formula=stages.dge[[i]][,j] ~ group*exposure, data=stages.dge[[i]])
    a <- anova(l)
    p <- a$`Pr(>F)`[1:3]
    pdat.stages[[i]][g,] <- p
  }
  
  pdat.stages[[i]] <- as.data.frame(pdat.stages[[i]])
  names(pdat.stages[[i]]) <- gsub(":", "_", names(pdat.stages[[i]]))
  
#Set up data for lm(): 
y.deg <- t(y$counts)
y.deg <- as.data.frame(y.deg)
y.deg <- TreatNames_sub(y.deg)

#Set up data frame to store p-values: 
d <- dim(y.deg)[2]-5
glist.y <- colnames(y.deg[,1:d])
cofs <- c("group", "exposure", "stage", "group:exposure", "group:stage", "exposure:stage", "group:exposure:stage")
pdat.y <- matrix(nrow=length(glist.y), ncol=length(cofs))
colnames(pdat.y) <- cofs
rownames(pdat.y) <- glist.y

#Run lm() on each gene: 
for (i in 1:ncol(y.deg[,1:d])) {
	g <- which(rownames(pdat.y)==colnames(y.deg)[i])
	l <- lm(formula=y.deg[,i] ~ group*exposure*stage, data=y.deg)
	a <- anova(l)
	p <- a$`Pr(>F)`[1:7]
	pdat.y[g,] <- p 
}

#Save p-values: 
pdat.y <- as.data.frame(pdat.y)
names(pdat.y) <- gsub(":", "_", names(pdat.y))
write.table(pdat.y, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180623_allstages_anova_unadj_pvalues_noouts.csv", 
		col.names=TRUE, row.names=TRUE, sep=",")

```

#### Adjust p-values for FDR

```{r}
#Vectorize and apply p.adjust to pdat.y dataframe
pval_all <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180623_allstages_anova_unadj_pvalues_noouts.csv", header=TRUE)

adj_pval_all <- setDT(pval_all, keep.rownames=TRUE)
colnames(adj_pval_all)[1] <- "Gene"
adj_pval_all <- adj_pval_all %>% 
	gather(`group`, `exposure`, `stage`, `group_exposure`, `group_stage`, `exposure_stage`, `group_exposure_stage`,
		key = "cof", value = "pvals")

adj_pval_all$adj_pvals <- p.adjust(adj_pval_all$pvals, method="fdr")

#Filter pvals by DEG (p < 0.05): 
deg_allstages <- adj_pval_all[adj_pval_all$adj_pvals <= 0.05,]

#Write adjusted pvalues to csv:
write.table(adj_pval_all, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180628_fdradj_pval_allstages.csv",
		col.names=TRUE, row.names=FALSE, sep=",")

write.table(deg_allstages, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180628_fdradj_p005_DEG_allstages.csv",
		col.names=TRUE, row.names=FALSE, sep=",")
```

### Save DEG unique to main or interaction effects for each stage: 

```{r}
a <- deg_allstages[deg_allstages$cof == "group",]
b <- deg_allstages[deg_allstages$cof == "exposure",]
c <- deg_allstages[deg_allstages$cof == "stage",]
d <- deg_allstages[deg_allstages$cof == "group_exposure",]
e <- deg_allstages[deg_allstages$cof == "group_stage",]
f <- deg_allstages[deg_allstages$cof == "exposure_stage",]
g <- deg_allstages[deg_allstages$cof == "group_exposure_stage",]

a2 <- a[!(a$Gene %in% b$Gene) & !(a$Gene %in% c$Gene) 
        & !(a$Gene %in% d$Gene) & !(a$Gene %in% e$Gene) & !(a$Gene %in% f$Gene) & !(a$Gene %in% g$Gene),]
b2 <- b[!(b$Gene %in% c$Gene) & !(b$Gene %in% a$Gene) 
        & !(b$Gene %in% d$Gene) & !(b$Gene %in% e$Gene) & !(b$Gene %in% f$Gene) & !(b$Gene %in% g$Gene),]
c2 <- c[!(c$Gene %in% a$Gene) & !(c$Gene %in% b$Gene)
        & !(c$Gene %in% d$Gene) & !(c$Gene %in% e$Gene) & !(c$Gene %in% f$Gene) & !(c$Gene %in% g$Gene),]
d2 <- d[!(d$Gene %in% a$Gene) & !(d$Gene %in% b$Gene)
        & !(d$Gene %in% c$Gene) & !(d$Gene %in% e$Gene) & !(d$Gene %in% f$Gene) & !(d$Gene %in% g$Gene),]
e2 <- e[!(e$Gene %in% a$Gene) & !(e$Gene %in% b$Gene)
        & !(e$Gene %in% c$Gene) & !(e$Gene %in% d$Gene) & !(e$Gene %in% f$Gene) & !(e$Gene %in% g$Gene),]
f2 <- f[!(f$Gene %in% a$Gene) & !(f$Gene %in% b$Gene)
        & !(f$Gene %in% c$Gene) & !(f$Gene %in% d$Gene) & !(f$Gene %in% e$Gene) & !(f$Gene %in% g$Gene),]
g2 <- g[!(g$Gene %in% a$Gene) & !(g$Gene %in% b$Gene)
        & !(g$Gene %in% c$Gene) & !(g$Gene %in% d$Gene) & !(g$Gene %in% e$Gene) & !(g$Gene %in% f$Gene),]

a3 <- a[!(a$Gene %in% d$Gene) & !(a$Gene %in% e$Gene) & !(a$Gene %in% f$Gene) & !(a$Gene %in% g$Gene),]

write.table(a2, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180628_adjp005_unique_group.csv", col.names=TRUE, row.names=FALSE, sep=",")
write.table(b2, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180628_adjp005_unique_exposure.csv", col.names=TRUE, row.names=FALSE, sep=",")
write.table(c2, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180628_adjp005_unique_stage.csv", col.names=TRUE, row.names=FALSE, sep=",")
write.table(d2, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180628_adjp005_unique_group_exposure.csv", col.names=TRUE, row.names=FALSE, sep=",")
write.table(e2, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180628_adjp005_unique_group_stage.csv", col.names=TRUE, row.names=FALSE, sep=",")
write.table(f2, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180628_adjp005_unique_exposure_stage.csv", col.names=TRUE, row.names=FALSE, sep=",")
write.table(g2, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180628_adjp005_unique_group_exposure_stage.csv", col.names=TRUE, row.names=FALSE, sep=",")

write.table(a3, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180628_adjp005_unique_group_noixns.csv", col.names=TRUE, row.names=FALSE, sep=",")
```

Check that subsetting worked: 

```{r}
g <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180628_adjp005_unique_group.csv")
ge <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180628_adjp005_unique_group_exposure.csv")
gs <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180628_adjp005_unique_group_stage.csv")
ges <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180628_adjp005_unique_group_exposure_stage.csv")

gtest<- a
getest <- d
gstest <- e
gestest <- f

n <- intersect(a$Gene, d$Gene)
m <- intersect(a$Gene, e$Gene)
o <- intersect(a$Gene, f$Gene)
nm <- intersect(n, m)
no <- intersect(n, o)
mo <- intersect(m, o)
nmo <- intersect(nm, o)
length(nmo)
length(n) + length(m) + length(o) - length(nm) - length(nmo)
nrow(a) - nrow(a2)
```

### Set up gene expression tables for MeV Heatmap

Extract read counts by DEG. Make gene lists for each treatment effect: 

```{r}

testa3 <- y[as.vector(a3$Gene),]$counts
tmvtest <- as.data.frame(t(testa3))
tmvtest <- TreatNames_sub(tmvtest)
tmvtest <- MeanVar(tmvtest)
tmvtest <- t(tmvtest$mean)
tmvtest <- tmvtest[,sort(colnames(tmvtest))]
trtnormtest <- as.data.frame(cbind(tmvtest[,1:4]-tmvtest[,1], tmvtest[,5:8]-tmvtest[,5], tmvtest[,9:12]-tmvtest[,9], tmvtest[,13:16]-tmvtest[,13], tmvtest[,17:20]-tmvtest[,17], tmvtest[,21:24]-tmvtest[,21]))
gnormtest <- as.data.frame(tmvtest-rowMeans(tmvtest))
write.table(trtnormtest, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180628_allstages_testgroup_trtnorm.txt", col.names=NA, row.names=TRUE, sep="\t")
write.table(gnormtest, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180628_allstages_testgroup_gnorm.txt", col.names=NA, row.names=TRUE, sep="\t")
  

all_cof <- list("group"=y[as.vector(a2$Gene),]$counts, "exposure"= y[as.vector(b2$Gene),]$counts, "stage"= y[as.vector(c2$Gene),]$counts, "group_exposure" = y[as.vector(d2$Gene),]$counts, "group_stage" =  y[as.vector(e2$Gene),]$counts, "exposure_stage" =  y[as.vector(f2$Gene),]$counts, "group_exposure_stage" =  y[as.vector(g2$Gene),]$counts) 

trtnorm <- list()
gnorm <- list()
tmv <- list()
for (i in 1:length(all_cof)) {
  tmv[[i]] <- as.data.frame(t(all_cof[[i]]))
  tmv[[i]] <- TreatNames_sub(tmv[[i]])
  tmv[[i]] <- MeanVar(tmv[[i]])
  tmv[[i]] <- t(tmv[[i]]$mean)
  tmv[[i]] <- tmv[[i]][,sort(colnames(tmv[[i]]))]
  trtnorm[[i]] <- as.data.frame(cbind(tmv[[i]][,1:4]-tmv[[i]][,1], tmv[[i]][,5:8]-tmv[[i]][,5], tmv[[i]][,9:12]-tmv[[i]][,9], tmv[[i]][,13:16]-tmv[[i]][,13], tmv[[i]][,17:20]-tmv[[i]][,17], tmv[[i]][,21:24]-tmv[[i]][,21]))
  gnorm[[i]] <- as.data.frame(tmv[[i]]-rowMeans(tmv[[i]]))
  write.table(trtnorm[[i]], paste("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180628_allstages_", names(all_cof[i]), "_trtnorm.txt", sep=""), col.names=NA, row.names=TRUE, sep="\t")
  write.table(gnorm[[i]], paste("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180628_allstages_", names(all_cof[i]), "_gnorm.txt", sep=""), col.names=NA, row.names=TRUE, sep="\t")
}

```

## Stage-Specific Analyses

Subset unfiltered, raw read counts by stage for stage-specific analyses: 
```{r}
ear <- zz[,zz$samples$stage=="19"]
mid <- zz[,zz$samples$stage=="28"]
lat <- zz[,zz$samples$stage=="35"]
```

#### Filter each stage subset independently:
```{r}
StageData <- list("ear"=ear,"mid"=mid, "lat"=lat)
for (i in 1:length(StageData)) {
	d = list()
	treat <- unique(StageData[[i]]$samples$trt)
	length(treat)
	for (j in 1:length(treat)) {
		a <- which(StageData[[i]]$samples$trt==treat[j])
		b <- colnames(StageData[[i]]$counts[,a])
		kp <- rowSums(StageData[[i]]$counts[,a] > 5) >=4 
		g <- which(kp==TRUE)
		d[[j]] <- g
	}

	filt_genes <- unique(names(unlist(d, use.names=TRUE)))
	length(filt_genes)
	StageData[[i]] <- StageData[[i]][filt_genes,]
}

# Save filtered background gene lists for each stage: 
for (i in 1:length(StageData)) {
  write.table(rownames(StageData[[i]]$counts), file= paste("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180322_", names(StageData[i]), "_background.csv", sep=""),
	col.names=FALSE, row.names=FALSE, sep="\t")
}

```

```{r}

#Transform each stage-specific subset by the same constant: 
for (i in 1:length(StageData)) {
  StageData[[i]]$counts <- log2(StageData[[i]]$counts + 8)
}

#Normalization of stage-specific subsets: 
mean_counts <- list()
length(mean_counts) <- 3
norm_counts <- list()
length(norm_counts) <- 3

for (i in 1:length(StageData)) {
  mean_counts[[i]] <- colMeans(StageData[[i]]$counts)
  norm_counts[[i]] <- sweep(StageData[[i]]$counts, 2, colMeans(StageData[[i]]$counts))
  grandmean[[i]] <- mean(mean_counts[[i]])
  norm_counts[[i]] <- norm_counts[[i]] + grandmean[[i]]
  StageData[[i]]$counts <- norm_counts[[i]]
}

ear <- StageData$ear
mid <- StageData$mid
lat <- StageData$lat


#Save normalized counts and samples for each stage subset: 
for (i in 1:length(StageData)) {
  c <- as.data.frame(StageData[[i]]$counts)
  write.table(c, paste("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_", names(StageData[i]),"_no_outlier_normcounts_noouts.csv", sep=""),  col.names=TRUE, row.names=TRUE, sep=",")
  
   write.table(StageData[[i]]$samples, paste("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_", names(StageData[i]),"_no_outlier_samples_noouts.csv", sep=""),  col.names=TRUE, row.names=TRUE, sep=",")
}

```


#### Stage-specific DEG Tests 

Perform lm() and anova() for each stage in one loop: 

```{r}
stages.dge <- list()
pdat.stages <- list()

for (i in 1:length(StageData)) {
  stages.dge[[i]] <- as.data.frame(t(StageData[[i]]$counts))
  names(stages.dge)[i] <- names(StageData)[i]
  stages.dge[[i]] <- TreatNames_sub(stages.dge[[i]])
  
  d <- dim(stages.dge[[i]])[2]-5
  glist <- colnames(stages.dge[[i]][,1:d])
  cofs <- c("group", "exposure", "group:exposure")
  pdat.stages[[i]] <- matrix(nrow=length(glist), ncol=length(cofs))
  colnames(pdat.stages[[i]]) <- cofs
  rownames(pdat.stages[[i]]) <- glist
  names(pdat.stages)[i] <- names(StageData)[i]
  
  for (j in 1:ncol(stages.dge[[i]][,1:d])) {
    g <- which(rownames(pdat.stages[[i]])==colnames(stages.dge[[i]])[j])
    l <- lm(formula=stages.dge[[i]][,j] ~ group*exposure, data=stages.dge[[i]])
    a <- anova(l)
    p <- a$`Pr(>F)`[1:3]
    pdat.stages[[i]][g,] <- p
  }
  
  pdat.stages[[i]] <- as.data.frame(pdat.stages[[i]])
  names(pdat.stages[[i]]) <- gsub(":", "_", names(pdat.stages[[i]]))
  write.table(pdat.stages[[i]], paste("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_",names(pdat.stages)[i],"_unadj_pvalues.csv"), 
		col.names=TRUE, row.names=TRUE, sep=",")
}

```

#### For each stage separately: 
Early (stage 19): 
```{r}
#Set up data for lm(): 
ear <- StageData$ear
ear.deg <- t(ear$counts)
ear.deg <- as.data.frame(ear.deg)
ear.deg <- TreatNames_sub(ear.deg)

#Run lm() on small subset of genes: 
t <- dim(ear.deg)[2]
test <- ear.deg[,(t-10):t]
l <- lm(formula=test[,"Funhe2EKm039226"] ~ group*exposure, data=test)
a <- anova(l)

#Set up data frame to store p-values: 
g <- dim(ear.deg)[2]-5
genelist.ear <- colnames(ear.deg[,1:g])
cof.ear <- rownames(a)[1:3]
pdat.ear <- matrix(nrow=length(genelist.ear), ncol=length(cof.ear))
colnames(pdat.ear) <- cof.ear
rownames(pdat.ear) <- genelist.ear

#Run lm() on each gene: 
for (i in 1:ncol(ear.deg[,1:g])) {
	g <- which(rownames(pdat.ear)==colnames(ear.deg)[i])
	l <- lm(formula=ear.deg[,i] ~ group*exposure, data=ear.deg)
	a <- anova(l)
	p <- a$`Pr(>F)`[1:3]
	pdat.ear[g,] <- p 
}

#Save p-values: 
pdat.ear <- as.data.frame(pdat.ear)
names(pdat.ear) <- gsub(":", "_", names(pdat.ear))
write.table(pdat.ear, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180322_stage19_anova_unadj_pvalues_noouts.csv", 
		col.names=TRUE, row.names=TRUE, sep=",")


```

Mid (stage 28):
This stage is unaffected by the removal of Stage 19 outliers

```{r}
mid <- StageData$mid
mid.dge <- t(mid$counts)
mid.dge <- as.data.frame(mid.dge)
mid.dge <- TreatNames_sub(mid.dge)

t <- dim(mid.dge)[2]
test <- mid.dge[,(t-10):t]
l <- lm(formula=test[,"Funhe2EKm031055"] ~ group*exposure, data=test)
a <- anova(l)

d <- dim(mid.dge)[2]-5
genelist.mid <- colnames(mid.dge[,1:d])
cof.mid <- rownames(a)[1:3]
pdat.mid <- matrix(nrow=length(genelist.mid), ncol=length(cof.mid))
colnames(pdat.mid) <- cof.mid
rownames(pdat.mid) <- genelist.mid

for (i in 1:ncol(mid.dge[,1:d])) {
	g <- which(rownames(pdat.mid)==colnames(mid.dge)[i])
	l <- lm(formula=mid.dge[,i] ~ group*exposure, data=mid.dge)
	a <- anova(l)
	p <- a$`Pr(>F)`[1:3]
	pdat.mid[g,] <- p 
}

pdat.mid <- as.data.frame(pdat.mid)
names(pdat.mid) <- gsub(":", "_", names(pdat.mid))
write.table(pdat.mid, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180322_stage28_anova_unadj_pvalues.csv", 
		col.names=TRUE, row.names=TRUE, sep=",")
```


Late (stage 35):
This stage is unaffected by the removal of Stage 19 outliers. 

```{r}
lat <- StageData$lat
lat.dge <- t(lat$counts)
lat.dge <- as.data.frame(lat.dge)
lat.dge <- TreatNames_sub(lat.dge)

t <- dim(lat.dge)[2]
test <- lat.dge[,(t-10):t]
l <- lm(formula=test[,"Funhe2EKm041134"] ~ group*exposure, data=test)
a <- anova(l)

d <- dim(lat.dge)[2]-5
genelist.lat <- colnames(lat.dge[,1:d])
cof.lat <- rownames(a)[1:3]
pdat.lat <- matrix(nrow=length(genelist.lat), ncol=length(cof.lat))
colnames(pdat.lat) <- cof.lat
rownames(pdat.lat) <- genelist.lat 

for (i in 1:ncol(lat.dge[,1:d])) {
	g <- which(rownames(pdat.lat)==colnames(lat.dge)[i])
	l <- lm(formula=lat.dge[,i] ~ group*exposure, data=lat.dge)
	a <- anova(l)
  p <- a$`Pr(>F)`[1:3]
	pdat.lat[g,] <- p 
}

pdat.lat <- as.data.frame(pdat.lat)
names(pdat.lat) <- gsub(":", "_", names(pdat.lat))
write.table(pdat.lat, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180322_stage35_anova_unadj_pvalues.csv", 
		col.names=TRUE, row.names=TRUE, sep=",")
```

#### Adjust p-values for FDR

```{r}
#Vectorize and apply p.adjust to stages 19, 28, and 35 subsets: 
fdr.ear <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_ear_unadj_pvalues.csv", header=TRUE)
fdr.mid <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_mid_unadj_pvalues.csv", header=TRUE)
fdr.lat <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_lat_unadj_pvalues.csv", header=TRUE)

fdr.ear$gene <- rownames(fdr.ear)
fdr.mid$gene <- rownames(fdr.mid)
fdr.lat$gene <- rownames(fdr.lat)

#pdat.stages <- list(early = fdr.ear, middle = fdr.mid, late = fdr.lat)
adj.pdat.stages <- list()
deg.stages <- list()

for (i in 1:length(names(pdat.stages))) {
	adj.pdat.stages[[i]] <- setDT(pdat.stages[[i]], keep.rownames=TRUE)
	colnames(adj.pdat.stages[[i]])[1] <- "Gene"
	adj.pdat.stages[[i]] <- adj.pdat.stages[[i]] %>% 
	gather(`group`, `exposure`, `group_exposure`, 
		key = "cof", value = "pvals")

	adj.pdat.stages[[i]]$adj.pvals <- p.adjust(adj.pdat.stages[[i]]$pvals, method="fdr")
	deg.stages[[i]] <- adj.pdat.stages[[i]][adj.pdat.stages[[i]]$adj.pvals <= 0.05,]
}

#for (i in 1:length(adj.pdat.stages)) {
#  adj.pdat.stages[[i]] <- adj.pdat.stages[[i]][,-1]
#  deg.stages[[i]] <- deg.stages[[i]][,-1]
#}

#Write all pvalues to csv. 

##For each stage subset: 
names(adj.pdat.stages) <- c("AdjPdatEar", "AdjPdatMid", "AdjPdatLat")
for (i in 1:length(names(adj.pdat.stages))) {
	write.table(adj.pdat.stages[[i]], paste("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_fdradj_pval_", names(adj.pdat.stages[i]), ".csv", sep=""), 
		col.names=TRUE, row.names=FALSE, sep=",")
}

#Write adjusted pvalues of DEG (p < 0.05) to csv:

names(deg.stages) <- c("ear", "mid", "lat") 
for (i in 1:length(names(deg.stages))) {
  if (nrow(deg.stages[[i]]) > 1) {
	write.table(deg.stages[[i]], paste("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_fdradj_005_deg_", names(adj.pdat.stages[i]), ".csv", sep=""), 
		col.names=TRUE, row.names=FALSE, sep=",")
  }
}

```


### Save DEG unique to main or interaction effects for each stage: 

```{r}
for (i in 1:length(names(deg.stages))) {
  a <- deg.stages[[i]][deg.stages[[i]]$cof=="group",]
  b <- deg.stages[[i]][deg.stages[[i]]$cof=="exposure",]
  c <- deg.stages[[i]][deg.stages[[i]]$cof=="group_exposure",]
  a2 <- a[!(a$Gene %in% c$Gene) & !(a$Gene %in% b$Gene),]
  b2 <- b[!(b$Gene %in% c$Gene) & !(b$Gene %in% a$Gene),]
  write.table(a2, paste("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_", names(pdat.stages[i]), "_unique_group.csv", sep=""), col.names=TRUE, row.names=FALSE, sep=",")
   write.table(b2, paste("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_", names(pdat.stages[i]), "_unique_exposure.csv", sep=""), col.names=TRUE, row.names=FALSE, sep=",")
    write.table(c, paste("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_", names(pdat.stages[i]), "_unique_gxe.csv", sep=""), col.names=TRUE, row.names=FALSE, sep=",")
}

```

Check that subsetting worked: 

```{r}
e_g <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_ear_unique_group.csv")
e_ex <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_ear_unique_exposure.csv")
e_ge <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_ear_unique_gxe.csv")

m_g <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_mid_unique_group.csv")
m_ex <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_mid_unique_exposure.csv")
m_ge <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_mid_unique_gxe.csv")

l_g <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_lat_unique_group.csv")
l_ex <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_lat_unique_exposure.csv")
l_ge <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_lat_unique_gxe.csv")

g<-deg.stages$lat[deg.stages$lat$cof=="group",]
e<-deg.stages$lat[deg.stages$lat$cof=="exposure",]
ge <-deg.stages$lat[deg.stages$lat$cof=="group_exposure",]

# n <- intersect(a$Gene, c$Gene)
# m <- intersect(a$Gene, b$Gene)
# nm <- length(intersect(n, m))
# length(n) + length(m) - nm
# nrow(a) - nrow(a2)
```

## Summarize gene expression patterns in heat map

Extract read counts by DEG. Make gene lists for each treatment effect: 

```{r}
ear <- StageData$ear
#For Stage 19 Only: normalize the first two effects since interaction effect only has 1 DEG 
e.cof <- list("group"=ear[as.vector(e_g$Gene),]$counts, "exposure"=ear[as.vector(e_ex$Gene),]$counts, "group_exposure"=ear[as.vector(e_ge$Gene),]$counts)
trtnorm.e <- list()
gnorm.e <- list()
tmv.e <- list()
for (i in 1:2) {
  tmv.e[[i]] <- as.data.frame(t(e.cof[[i]]))
  tmv.e[[i]] <- TreatNames_sub(tmv.e[[i]])
  tmv.e[[i]] <- MeanVar(tmv.e[[i]])
  tmv.e[[i]] <- t(tmv.e[[i]]$mean)
  tmv.e[[i]] <- tmv.e[[i]][,sort(colnames(tmv.e[[i]]))]
  trtnorm.e[[i]] <- as.data.frame(cbind(tmv.e[[i]][,1:4]-tmv.e[[i]][,1], tmv.e[[i]][,5:8]-tmv.e[[i]][,5]))
  gnorm.e[[i]] <- as.data.frame(tmv.e[[i]]-rowMeans(tmv.e[[i]]))
  write.table(trtnorm.e[[i]], paste("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_early_", names(e.cof[i]), "_trtnorm.txt", sep=""), col.names=NA, row.names=TRUE, sep="\t")
  write.table(gnorm.e[[i]], paste("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_early_", names(e.cof[i]), "_gnorm.txt", sep=""), col.names=NA, row.names=TRUE, sep="\t")
}

mid <- StageData$mid
lat <- StageData$lat
#For the rest of the stages: 
all <- list("mid" = mid, "late"=lat)
m <- list(m_g, m_ex, m_ge)
l <- list(l_g, l_ex, l_ge)
stagecounts <- list("mid"=m, "late"=l)
trtnorm <- list()
trtnorm$m <- list()
trtnorm$l <- list()

gnorm <- list()
gnorm[[1]] <- list()
gnorm[[2]] <- list()

#Set up gene lists for treatment normalization
for (i in 1:length(stagecounts)) {
  for (j in 1:length(stagecounts[[i]])) {
    trtnorm[[i]][[j]] <- all[[i]][as.vector(stagecounts[[i]][[j]]$Gene),]$counts
    names(trtnorm[[i]])[j] <- as.vector(unique(stagecounts[[i]][[j]]$cof))
  }
}

tmv <- list()
tmv[[1]] <- list()
tmv[[2]] <- list()

#Calculate expression values for both normalization for treatment means and grand means
for (i in 1:length(trtnorm)) {
  for (j in 1:length(trtnorm[[i]])) {
    tmv[[i]][[j]] <- as.data.frame(t(trtnorm[[i]][[j]]))
    tmv[[i]][[j]] <- TreatNames_sub(tmv[[i]][[j]])
    tmv[[i]][[j]] <- MeanVar(tmv[[i]][[j]])
    tmv[[i]][[j]] <- t(tmv[[i]][[j]]$mean)
    tmv[[i]][[j]] <- tmv[[i]][[j]][,sort(colnames(tmv[[i]][[j]]))]
    trtnorm[[i]][[j]] <- as.data.frame(cbind(tmv[[i]][[j]][,1:4]-tmv[[i]][[j]][,1], tmv[[i]][[j]][,5:8]-tmv[[i]][[j]][,5]))
    gnorm[[i]][[j]] <- as.data.frame(tmv[[i]][[j]]-rowMeans(tmv[[i]][[j]]))
    write.table(trtnorm[[i]][[j]], paste("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180403_", names(trtnorm[i]), "_",  names(trtnorm[[i]][j]), "_trtnorm.txt", sep=""), col.names=NA, row.names=TRUE, sep="\t")
     write.table(gnorm[[i]][[j]], paste("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180403_", names(trtnorm[i]), "_",  names(trtnorm[[i]][j]), "_gnorm.txt", sep=""), col.names=NA, row.names=TRUE, sep="\t")
  }
}

```

## DAVID Analysis set up
After generating heatmaps and performing cluster analysis, save all clustered genes into a multi-list file for DAVID, making sure to extract only the genes with uniprot accession numbers

1. List saved cluster files and import their data
2. Make empty dataframe with n columns, n=number of total cluster files
3. Name of cluster file --> name of column, pipe funhe gene id's from each file into each column
4. Make another empty dataframe with same column names and number of columns
5. For every item in the column vector, if there's an entry for the uniprot accession, then write that uniprot entry into the dataframe
6. Repeat above for background genelists for each stage.

```{r}
dir <- "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/mev_heatmap_expression_tables"
files_list <- list.files(path = dir, pattern = "180628_")
files <- file.path(dir, files_list)
filenames <- gsub("180628_", "", files_list)
filenames <- gsub(".txt", "", filenames)

#Dump cluster gene lists into a list element
geneclusters <- list()
for (i in 1:length(files)) {
  geneclusters[[i]] <- read.csv(files[i], header=TRUE, sep = "\t")
  colnames(geneclusters[[i]])[2] <- "Gene"
  names(geneclusters)[i] <- filenames[i]
  geneclusters[[i]] <- as.vector(geneclusters[[i]]$Gene)
}

#Filter above genes by those with uniprot accession number: 
library(readxl)
genemodels <- as.data.frame(read_xlsx("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/Gene.Models.Conservative.and.Liberal.xlsx"))
names(genemodels) <- c("geneID", "name", "cons", "lib")
unip <- list()

for (i in 1:length(geneclusters)){
  unip[[i]] <- genemodels[genemodels$geneID %in% geneclusters[[i]],]$lib
  unip[[i]] <- unip[[i]][!is.na(unip[[i]])]
  names(unip)[i] <- names(geneclusters)[i]
}
#Assign same length to all vectors, then run cbind: 
n <- max(lengths(unip))
for (i in 1:length(unip)) {
  length(unip[[i]]) <- n
}
david <- do.call(cbind, unip)
david[is.na(david)] <- " " 
write.table(david, file="~/Documents/NIEHS_LSU_UCD/rnaseq/david_results/180628_clustergenelists.txt", row.names = FALSE, col.names = TRUE, sep="\t", quote=FALSE)

#Compile background genelist for all-stages analysis by uniprot accession IDs and store one multi-list file: 

bg <- as.vector(rownames(y$counts))
bg_unip <- genemodels[genemodels$geneID %in% bg,]$lib
bg_unip <- bg_unip[!is.na(bg_unip)]
bg_unip <- as.data.frame(bg_unip)
write.table(bg_unip, file="~/Documents/NIEHS_LSU_UCD/rnaseq/david_results/180628_backgroundgenelists.txt", row.names=FALSE, col.names=TRUE, sep="\t", quote=FALSE)


#Compile background genelists for stage-specific analyses by uniprot accession IDs and store one multi-list file: 
bg <- vector("list", 3)
bg_unip <- vector("list", 3)
for (i in 1:length(StageData)) {
  bg[[i]] <- as.vector(rownames(StageData[[i]]$counts))
  names(bg)[i] <- names(StageData[i])
  bg_unip[[i]] <- genemodels[genemodels$geneID %in% bg[[i]],]$lib
  bg_unip[[i]] <- bg_unip[[i]][!is.na(bg_unip[[i]])]
  names(bg_unip)[i] <- names(StageData[i])
  length(bg_unip[[i]]) <- max(lengths(bg_unip))
}
david_bg <- do.call(cbind, bg_unip)
write.table(david_bg, file="~/Documents/NIEHS_LSU_UCD/rnaseq/david_results/180409_backgroundgenelists.txt", row.names=FALSE, col.names=TRUE, sep="\t", quote=FALSE)


```


## Venn Diagrams: 

```{r}

##Venn Diagram of parent DEGs across stage-specific analyses: 
library(VennDiagram)
venn.diagram(
x = list(e_g$Gene, m_g$Gene, l_g$Gene),
category.names = c("Stage 19 Parent DEG" , "Stage 28 Parent DEG " , "Stage 35 Parent DEG"),
filename = 'parent_DEG_venn.tiff',
        output = TRUE ,
        height = 3000, 
        width = 3000, 
        resolution = 500, 
        imagetype = "tiff", 
        units = "px", 
        compression ="lzw",
        lwd = 2,
        lty = 'blank',
        fill = c('yellow', 'purple', 'green'),
        cex = 1,
        fontface = "bold",
        fontfamily = "sans",
        cat.cex = 0.6,
        cat.fontface = "bold",
        cat.default.pos = "outer",
        cat.pos = c(-27, 27, 135),
        cat.dist = c(0.055, 0.055, 0.085),
        cat.fontfamily = "sans",
        rotation = 1)


##Venn Diagram of exposure genes across stages: 

venn.diagram(
x = list(e_ex$Gene, m_ex$Gene, l_ex$Gene),
category.names = c("Stage 19 Embryo Exp DEG" , "Stage 28 Embryo Exp DEG " , "Stage 35 Embryo Exp DEG"),
filename = 'exp_DEG_venn.tiff',
        output = TRUE ,
        height = 3000, 
        width = 3000, 
        resolution = 500, 
        imagetype = "tiff", 
        units = "px", 
        compression ="lzw",
        lwd = 2,
        lty = 'blank',
        fill = c('yellow', 'purple', 'green'),
        cex = 1,
        fontface = "bold",
        fontfamily = "sans",
        cat.cex = 0.6,
        cat.fontface = "bold",
        cat.default.pos = "outer",
        cat.pos = c(-27, 27, 135),
        cat.dist = c(0.055, 0.055, 0.085),
        cat.fontfamily = "sans",
        rotation = 1)

```

## Calculate mean-normalized expression values for the DEG for parental main effect at Stage 19 across all stages: 

```{r}
#Import gene order from MeV hierarchical clustering: 
gorder <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180403_early_group_geneorder.txt", header=TRUE, sep = "\t")

#Make sure that the expression values pulled from larger data set look right by looking at expression patterns in just stage 19 samples from larger dataset y: 
egtest <- y[as.vector(gorder$X), y$samples$stage=="19"]$counts

tmv <- as.data.frame(t(egtest))
tmv <- TreatNames_sub(tmv)
tmv <- MeanVar(tmv)
tmv <- t(tmv$mean)
tmv <- tmv[,sort(colnames(tmv))]
tmv <- tmv - rowMeans(tmv)
write.table(tmv, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_st19_test.txt", col.names=NA, row.names=TRUE, sep="\t")


#Extract expression values for all stages from the larger data set: 
early_g <- y[as.vector(gorder$X), y$samples$stage=="19"]$counts
mid_g <- y[as.vector(gorder$X), y$samples$stage=="28"]$counts
late_g <- y[as.vector(gorder$X), y$samples$stage=="35"]$counts

eg <- list(early_g, mid_g, late_g)

#Normalize to each stage mean for visualization: 
for (i in 1:length(eg)) {
  eg[[i]] <- as.data.frame(t(eg[[i]]))
  eg[[i]] <- TreatNames_sub(eg[[i]])
  eg[[i]] <- MeanVar(eg[[i]])
  eg[[i]] <- t(eg[[i]]$mean)
  eg[[i]] <- eg[[i]][,sort(colnames(eg[[i]]))]
  eg[[i]] <- eg[[i]] - rowMeans(eg[[i]])
}

eg <- do.call(cbind, eg)
write.table(eg, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180403_st19_parentDEG_allstages.txt", col.names=NA, row.names=TRUE, sep="\t")

#Normalize to the total grand mean: 
# all_deg <- y[as.vector(gorder$X), ]$counts
# tmv <- as.data.frame(t(all_deg))
# tmv <- TreatNames_sub(tmv)
# tmv <- MeanVar(tmv)
# tmv <- t(tmv$mean)
# tmv <- tmv[,sort(colnames(tmv))]
# tmv <- tmv - rowMeans(tmv)
# write.table(tmv, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180314_st19_parentDEG_allgnorm.txt", col.names=NA, row.names=TRUE, sep="\t")


```


#### Visualizing parental main effect genes from mid and late stage-specific analyses across whole data set: 

```{r}
#Import gene order from hierarchical clustering from MeV
m_g <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180403_st28_group_geneorder.txt", header=TRUE, sep="\t")
l_g <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180403_st35_group_geneorder.txt", header=TRUE, sep = "\t")


#Normalize expression values to the grand mean for each stage:
mg_19 <- y[as.vector(m_g$X), y$samples$stage=="19"]$counts
mg_28 <- y[as.vector(m_g$X), y$samples$stage=="28"]$counts
mg_35 <- y[as.vector(m_g$X), y$samples$stage=="35"]$counts

lg_19 <- y[as.vector(l_g$X), y$samples$stage=="19"]$counts
lg_28 <- y[as.vector(l_g$X), y$samples$stage=="28"]$counts
lg_35 <- y[as.vector(l_g$X), y$samples$stage=="35"]$counts

mg <- list(mg_19, mg_28, mg_35)
lg <- list(lg_19, lg_28, lg_35)

for (i in 1:length(mg)) {
  mg[[i]] <- as.data.frame(t(mg[[i]]))
  mg[[i]] <- TreatNames_sub(mg[[i]])
  mg[[i]] <- MeanVar(mg[[i]])
  mg[[i]] <- t(mg[[i]]$mean)
  mg[[i]] <- mg[[i]][,sort(colnames(mg[[i]]))]
  mg[[i]] <- mg[[i]] - rowMeans(mg[[i]])
}
mg <- do.call(cbind, mg)

for (i in 1:length(lg)) {
  lg[[i]] <- as.data.frame(t(lg[[i]]))
  lg[[i]] <- TreatNames_sub(lg[[i]])
  lg[[i]] <- MeanVar(lg[[i]])
  lg[[i]] <- t(lg[[i]]$mean)
  lg[[i]] <- lg[[i]][,sort(colnames(lg[[i]]))]
  lg[[i]] <- lg[[i]] - rowMeans(lg[[i]])
}
lg <- do.call(cbind, lg)

write.table(mg, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180404_st28_parent_allstages.txt", col.names=NA, row.names=TRUE, sep="\t")
write.table(lg, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180404_st35_parent_allstages.txt", col.names=NA, row.names=TRUE, sep="\t")

```


## Look at inter-individual variation in non-DEG 

Visualize gene expression between parent control and parent exposed groups, or plot inviduals on MDS space:

```{r}

#Drop all DEG from stage 19 dataframe: 
e_g <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_ear_unique_group.csv")
e_ex <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_ear_unique_exposure.csv")
e_ge <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_ear_unique_gxe.csv")

exgenes <- c(as.vector(e_g$Gene), as.vector(e_ex$Gene), as.vector(e_ge$Gene))
ex <- which(exgenes %in% rownames(ear$counts))
mat <- ear[-ex,]

#Make MDS plot:
par(mfrow=c(1,1))
group <- mat$samples$group
treats <- mat$samples$trt
exp <- mat$samples$exposure

col.group <- as.factor(group)
levels(col.group) <- c("blue", "red")
col.group <- as.character(col.group)

col.exp <- as.factor(exp)
levels(col.exp) <- brewer.pal(nlevels(col.exp), "Dark2")
col.exp <- as.character(col.exp)

col.treat <- as.factor(treats)
levels(col.treat) <- brewer.pal(nlevels(col.treat), "Set1")
col.treat <- as.character(col.treat)

plotMDS(mat, top=19974, labels=treats, col=col.group, dim=c(1,2), gene.selection="common", method="bcv", main="Stage 19 Individuals Expression of Background Genes")


#Make PCA Plot: 

library("FactoMineR")
library("factoextra")

#Transpose data frame to put variables(genes) into columns: 
matc <- t(mat$counts)

#Compute PCA:
res.pca <- prcomp(matc, scale=TRUE)

#Visualize eigenvalues
fviz_eig(res.pca)

#Visualize individuals in PCA plot: 
groups <- as.factor(mat$samples$group)
doses <- as.factor(mat$samples$exposure)

e_pca <- fviz_pca_ind(res.pca,
             #geom.ind = "point",
             col.ind = groups, # Color by groups
             palette = c("#00AFBB","#FC4E07"),
             addEllipses = TRUE,
             ellipse.type = "confidence",
             legend.title = "Parent Treatment Group",
             repel = FALSE) +    # Avoid text overlapping 
             labs(title ="Stage 19 Individuals")

#Look at dimension description:
ind <- get_pca_ind(res.pca)
ind
res.desc <- dimdesc(res.pca, axes=1:2, proba=0.05)

fviz_contrib(res.pca, choice = "ind", axes = 1:2)

```


```{r}
m <- c(as.vector(m_g$Gene), as.vector(m_ex$Gene), as.vector(m_ge$Gene))
l <- c(as.vector(l_g$Gene), as.vector(l_ex$Gene), as.vector(l_ge$Gene))

mex <- which(m %in% rownames(mid$counts)) 
lex <- which(l %in% rownames(lat$counts))

mpca <- t(mid$counts[-mex,])
lpca <- t(lat$counts[-lex,])

#Compute PCA:
m.pca <- prcomp(mpca, scale=TRUE)
l.pca <- prcomp(lpca, scale=TRUE)

#Visualize eigenvalues
fviz_eig(m.pca)
fviz_eig(l.pca)

#Visualize individuals in PCA plot: 
m_groups <- as.factor(mid$samples$group)
m_doses <- as.factor(mid$samples$exposure)

l_groups <- as.factor(lat$samples$group)
l_doses <- as.factor(lat$samples$exposure)

m_pca <- fviz_pca_ind(m.pca,
             #geom.ind = "point",
             col.ind = m_groups, # Color by groups
             palette = c("#00AFBB","#FC4E07"),
             addEllipses = TRUE,
             ellipse.type = "confidence",
             legend.title = "Parent Treatment",
             repel = FALSE) +
   labs(title ="Stage 28 Individuals")

l_pca <- fviz_pca_ind(l.pca,
             #geom.ind = "point",
             col.ind = l_groups, # Color by groups
             palette = c("#00AFBB","#FC4E07"),
             addEllipses = TRUE,
             ellipse.type = "confidence",
             legend.title = "Parent Treatment",
             repel = FALSE)   +
            labs(title ="Stage 35 Individuals")

all_pca <- multiplot(e_pca, m_pca, l_pca, cols=3)

```

## Look at inter-individual variation in DEG expression between parent control and parent exposed groups, or plot inviduals on MDS space:

```{r}

#Drop all DEG from stage 19 dataframe: 
e_g <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_ear_unique_group.csv")
m_g <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_mid_unique_group.csv")
l_g <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_lat_unique_group.csv")

all_g <- list("Early"=e_g, "Mid"=m_g, "Late"=l_g)
ex <- vector("list", 3)
for (i in 1:3) {
  all_g[[i]] <- as.vector(all_g[[i]]$Gene)
  ex[[i]] <- which(rownames(StageData[[i]]$counts) %in% ex[[i]])
  all_g[[i]] <- StageData[[i]][all_g[[i]],]
}

#Make PCA Plot: 

library("FactoMineR")
library("factoextra")

#Transpose data frame to put variables(genes) into columns: 
mat <- vector("list", 3)
for (i in 1:3) {
  mat[[i]] <- t(all_g[[i]]$counts)
}

#Compute PCA:
res.pca <- lapply(mat, "prcomp")

#Visualize eigenvalues
#fviz_eig(res.pca)

#Visualize individuals in PCA plot: 
e_groups <- as.factor(ear$samples$group)

m_groups <- as.factor(mid$samples$group)
m_doses <- as.factor(mid$samples$exposure)

l_groups <- as.factor(lat$samples$group)
l_doses <- as.factor(lat$samples$exposure)


edeg_pca <- fviz_pca_ind(res.pca[[1]],
             #geom.ind = "point",
             col.ind = e_groups, # Color by groups
             palette = c("#00AFBB","#FC4E07"),
             addEllipses = TRUE,
             ellipse.type = "confidence",
             legend.title = "Parent Treatment Group",
             repel = FALSE) +    # Avoid text overlapping 
             labs(title ="Stage 19 Individuals")

mdeg_pca <- fviz_pca_ind(res.pca[[2]],
             #geom.ind = "point",
             col.ind = m_groups, # Color by groups
             palette = c("#00AFBB","#FC4E07"),
             addEllipses = TRUE,
             ellipse.type = "confidence",
             legend.title = "Parent Treatment Group",
             repel = FALSE) +    # Avoid text overlapping 
             labs(title ="Stage 28 Individuals")

ldeg_pca <- fviz_pca_ind(res.pca[[3]],
             #geom.ind = "point",
             col.ind = l_groups, # Color by groups
             palette = c("#00AFBB","#FC4E07"),
             addEllipses = TRUE,
             ellipse.type = "confidence",
             legend.title = "Parent Treatment Group",
             repel = FALSE) +    # Avoid text overlapping 
             labs(title ="Stage 35 Individuals")

edeg_pca
mdeg_pca
ldeg_pca
gdeg_pca <- multiplot(edeg_pca, mdeg_pca, ldeg_pca, cols=3)

#Make MDS plot:
par(mfrow=c(1,1))
group <- mat$samples$group
treats <- mat$samples$trt
exp <- mat$samples$exposure

col.group <- as.factor(group)
levels(col.group) <- c("blue", "red")
col.group <- as.character(col.group)

col.exp <- as.factor(exp)
levels(col.exp) <- brewer.pal(nlevels(col.exp), "Dark2")
col.exp <- as.character(col.exp)

col.treat <- as.factor(treats)
levels(col.treat) <- brewer.pal(nlevels(col.treat), "Set1")
col.treat <- as.character(col.treat)

plotMDS(mat, labels=treats, col=col.group, main="Stage 19 Individuals By Parent DEGs")

```


## Comparing the variance of non-DEG expression between Exposed and Control Parent Groups

For stage 19: 

```{r}
#Using all genes, including DEG: 
pc <- ear[,ear$samples$group=="C"]
pe <- ear[, ear$samples$group=="E"]


# #Drop all DEG from stage 19 dataframe, also subsetting by parent treatment group: 
# e_g <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_ear_unique_group.csv")
# e_ex <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_ear_unique_exposure.csv")
# e_ge <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_ear_unique_gxe.csv")
# 
# exgenes <- c(as.vector(e_g$Gene), as.vector(e_ex$Gene), as.vector(e_ge$Gene))
# ex <- which(exgenes %in% rownames(ear$counts))
# 
# pc <- ear[-ex, ear$samples$group=="C"]
# pe <- ear[-ex, ear$samples$group=="E"]

#Calculate variance for each treatment group and visualize in density plot: 
pc  <- as.data.frame(t(pc$counts))
pc <- TreatNames_sub(pc)
pc <- MeanVar(pc)

pe  <- as.data.frame(t(pe$counts))
pe <- TreatNames_sub(pe)
pe <- MeanVar(pe)

#Combine variances from each data frame into one data frame for visualization: 
pc <- pc$stdev
pe <- pe$stdev

library(tidyr)
library(dplyr)
library(data.table)
library(ggplot2)
pc1 <- setDT(as.data.frame(pc), keep.rownames = TRUE)

pc1 <- gather(pc1, Gene, stdev, colnames(pc1)[2:ncol(pc1)])
pc1$group <- 'C'

pc2 <- setDT(as.data.frame(pe), keep.rownames = TRUE)
pc2 <- gather(pc2, Gene, stdev, colnames(pc2)[2:ncol(pc2)])
pc2$group <- 'E'

#Now, combine your two dataframes into one.  First make a new column in each that will be a variable to identify where they came from later.

early_var <- as.data.frame(rbind(pc1, pc2))

#After that, which is unnecessary if your data is in long formal already, you only need one line to make your plot.

stdens <- ggplot(early_var, aes(stdev, fill = group)) +
  geom_density(alpha = 0.2) +
  scale_fill_brewer(palette="Dark2") +
  theme_classic() + 
  ggtitle("Density of Variance of All Non-DEG at Stage 19")

stdens

```

Repeat the process above for stage 28 and 35 genes: 

```{r}

#Load all the DEGs found at each stage
m_g <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_mid_unique_group.csv")
m_ex <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_mid_unique_exposure.csv")
m_ge <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_mid_unique_gxe.csv")

l_g <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_lat_unique_group.csv")
l_ex <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_lat_unique_exposure.csv")
l_ge <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_lat_unique_gxe.csv")

#Set up your data frames to subset by stage and non-DEG
m <- c(as.vector(m_g$Gene), as.vector(m_ex$Gene), as.vector(m_ge$Gene))
l <- c(as.vector(l_g$Gene), as.vector(l_ex$Gene), as.vector(l_ge$Gene))

mex <- which(m %in% rownames(mid$counts))
lex <- which(l %in% rownames(lat$counts))

mc <- mid[-mex, mid$samples$group=="C"]
me <- mid[-mex, mid$samples$group=="E"]
m28 <- list(mc, me)

lc <- lat[-lex, lat$samples$group=="C"]
le <- lat[-lex, lat$samples$group=="E"]
l35 <- list(lc, le)

ml <- list("mc"=mc, "me"=me, "lc"=lc, "le"=le)

#Calculate variance for each treatment group and visualize in histogram: 
ml_var <- list()

for (i in 1:length(ml)) {
  ml[[i]] <- as.data.frame(t(ml[[i]]$counts))
  ml[[i]] <- TreatNames_sub(ml[[i]])
  ml[[i]] <- MeanVar(ml[[i]])
  ml[[i]] <- ml[[i]]$stdev
  ml_var[[i]] <- setDT(as.data.frame(ml[[i]]), keep.rownames = TRUE)
  ml_var[[i]] <- gather(ml_var[[i]], Gene, stdev, colnames(ml_var[[i]])[2:ncol(ml_var[[i]])])
}


m_pc <- ml_var[[1]]
m_pc$group <- 'C'
m_pe <- ml_var[[2]]
m_pe$group <- 'E'
mid_var <- rbind(m_pc, m_pe)

mvar <- ggplot(mid_var, aes(stdev, fill = group)) +
  geom_density(alpha = 0.2) +
  scale_fill_brewer(palette="Dark2") +
  theme_classic() +
  ggtitle("Density of Variance of All Non-DEG at Stage 28")

l_pc <- ml_var[[3]]
l_pc$group <- 'C'
l_pe <- ml_var[[4]]
l_pe$group <- 'E'
late_var <- rbind(l_pc, l_pe)

lvar <- ggplot(late_var, aes(stdev, fill = group)) +
  geom_density(alpha = 0.2) +
  scale_fill_brewer(palette="Dark2") +
  theme_classic() +
  ggtitle("Density of Variance of All Non-DEG at Stage 35")

all_var <- multiplot(stdens, mvar, lvar, col=1)

```


## Visualize the log2FC of Stage19 Parent Group DEGs across stages

```{r}
library(data.table)
source("~/Documents/NIEHS_LSU_UCD/scripts/fun_multiplot.R")

e_g <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_ear_unique_group.csv")
m_g <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_mid_unique_group.csv")
l_g <- read.csv("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180329_adjp005_lat_unique_group.csv")
all_g <- list("e"=e_g, "m"=m_g, "l"=l_g)

#Subset larger data set by the DEGs for parent main effect from each stage analysis, and calculate logFC between pe and pc treatments: 
degs <- list()
for (i in 1:length(all_g)) {
  degs[[i]] <- y[as.vector(all_g[[i]]$Gene),]
  degs[[i]] <- as.data.frame(t(degs[[i]]$counts))
  degs[[i]] <- TreatNames_sub(degs[[i]])
  degs[[i]] <- TreatMeans(degs[[i]])
  degs[[i]] <- t(degs[[i]])
  degs[[i]] <- degs[[i]][,sort(colnames(degs[[i]]))]
  
  degs[[i]] <- data.frame(cbind("early" = rowMeans(degs[[i]][,13:16]) - rowMeans(degs[[i]][,1:4]), 
              "mid" = rowMeans(degs[[i]][,17:20]) - rowMeans(degs[[i]][,5:8]), 
              "late"= rowMeans(degs[[i]][,21:24]) - rowMeans(degs[[i]][,9:12])))
  
  degs[[i]] <- setDT(degs[[i]], keep.rownames = TRUE)
  colnames(degs[[i]])[1] <- "Gene"
  degs[[i]]$DEG <- "DE"
  degs[[i]] <- gather(degs[[i]], Stage, logFC, "early":"late")
  degs[[i]]$absFC <- abs(degs[[i]]$logFC)
}

names(degs) <- c("Stage 19", "Stage 28", "Stage 35")

#Make graph:
hoc_plots <- list()
for (i in 1:length(degs)) {
  hoc_plots[[i]] <- ggplot(data=degs[[i]], aes(x=Stage, y=logFC, group=Gene)) +
    geom_line() +
    geom_point() +
    scale_x_discrete(limits=c("early","mid","late")) +
    xlab("Developmental Stage") +
    ggtitle(names(degs)[[i]])
}

hoc_plots[[2]]
hcplots_all <- multiplot(hoc_plots[[1]], hoc_plots[[2]], hoc_plots[[3]], cols=3)
```


## Visualize distribution of logFC between PC and PE of Stage 19 Parent DEGs across development

```{r}
#First establish dataframe of logFC of randomly sampled genes from larger data set: 
testrand <- list()
ty <- list()
fc_dens <- list()

for (i in 1:length(all_g)) {
  testrand[[i]] <- replicate(1000, sample(rownames(y$counts), size=nrow(all_g[[i]]), replace=FALSE))
}

for (i in 1:length(testrand)) {
  for (j in 1:ncol(testrand[[i]])) {
    ty[[j]] <- y[as.vector(testrand[[i]][,j]),]$counts
    ty[[j]]  <- as.data.frame(t(ty[[j]]))
    ty[[j]] <- TreatNames_sub(ty[[j]])
    ty[[j]] <- TreatMeans(ty[[j]])
    ty[[j]] <- t(ty[[j]])
    ty[[j]] <- data.frame(ty[[j]][,sort(colnames(ty[[j]]))])
    
    ty[[j]] <- data.frame(cbind("early" = rowMeans(ty[[j]][,13:16]) - rowMeans(ty[[j]][,1:4]), 
                                "mid" = rowMeans(ty[[j]][,17:20]) - rowMeans(ty[[j]][,5:8]), 
                                "late"= rowMeans(ty[[j]][,21:24]) - rowMeans(ty[[j]][,9:12])))
    
    ty[[j]] <- setDT(ty[[j]], keep.rownames = TRUE)
    colnames(ty[[j]])[1] <- "Gene"
    ty[[j]]$DEG <- j 
    ty[[j]] <- gather(ty[[j]], Stage, logFC, "early":"late")
    fc_dens[[i]] <- rbindlist(ty)
  }
  fc_dens[[i]]$absFC <- abs(fc_dens[[i]]$logFC)
  fc_dens[[i]] <- rbind(fc_dens[[i]], degs[[i]])
}

names(fc_dens) <- names(degs)

for (i in 1:3) {
  fc_dens[[i]]$Stage <- factor(fc_dens[[i]]$Stage, levels=c("early", "mid", "late"))
}


#Visualize distribution of the absolute value logFC of 245 Stage 19 parent DEGs vs 245 randomly selected genes at Stage 19: 
st19p <- ggplot(fc_dens[[1]], aes(x = absFC, fill=DEG=="DE")) +
  facet_wrap(~Stage, as.table=FALSE, dir="v") + 
  geom_density(aes(y=..scaled..), alpha = 0.4) +
  scale_fill_manual(values= c("FALSE"="grey", "TRUE"="Green")) + 
  theme_classic() + 
  xlab("absolute(logFC)") +
  ylab("Density") +
  labs(title=paste('Distribution of', names(fc_dens)[1], 'Parent DEG LogFC', sep=" "), subtitle="245 DEG") 

st28p <- ggplot(fc_dens[[2]], aes(x = absFC, fill=DEG=="DE")) +
  facet_wrap(~Stage, as.table=FALSE, dir="v") + 
  geom_density(aes(y=..scaled..), alpha = 0.4) +
  scale_fill_manual(values= c("FALSE"="grey", "TRUE"="#00CC99")) + 
  theme_classic() + 
  xlab("absolute(logFC)") +
  ylab("Density") +
  labs(title=paste('Distribution of', names(fc_dens)[2], 'Parent DEG LogFC', sep=" "), subtitle="211 DEG")

st35p <- ggplot(fc_dens[[3]], aes(x = absFC, fill=DEG=="DE")) +
  facet_wrap(~Stage, as.table=FALSE, dir="v") + 
  geom_density(aes(y=..scaled..), alpha = 0.4) +
  scale_fill_manual(values= c("FALSE"="grey", "TRUE"="#006600")) + 
  theme_classic() + 
  xlab("absolute(logFC)") +
  ylab("Density") +
  labs(title=paste('Distribution of', names(fc_dens)[3], 'Parent DEG LogFC', sep=" "), subtitle="566 DEG")

fcplots_all <- multiplot(st19p, st28p, st35p, cols=3)


#Alternative to facet_wrap
densplots <- vector("list", 3) 
for (j in 1:3) {
  densplots[[1]][[j]] <- ggplot(fc_dens[[1]][fc_dens[[1]]$Stage==unique(fc_dens[[1]]$Stage)[j]], aes(x = absFC, fill=DEG=="DE")) +
  geom_density(aes(y=..scaled..), alpha = 0.4) +
  scale_fill_manual(values= c("FALSE"="grey", "TRUE"="Green")) + 
  theme_classic() + 
  xlab("absolute(logFC)") +
  ylab("Density") +
  ggtitle(paste('Distribution of', names(fc_dens)[1], 'Parent DEG LogFC in', names(fc_dens)[j], sep=" ")) 
  
  densplots[[2]][[j]] <- ggplot(fc_dens[[2]][fc_dens[[2]]$Stage==unique(fc_dens[[2]]$Stage)[j]], aes(x = absFC, fill=DEG=="DE")) +
  geom_density(aes(y=..scaled..), alpha = 0.4) +
  scale_fill_manual(values= c("FALSE"="grey", "TRUE"="#00CC99")) + 
  theme_classic() + 
  xlab("absolute(logFC)") +
  ylab("Density") +
  ggtitle(paste('Distribution of', names(fc_dens)[2], 'Parent DEG LogFC in', names(fc_dens)[j], sep=" ")) 
  
  densplots[[3]][[j]] <- ggplot(fc_dens[[3]][fc_dens[[3]]$Stage==unique(fc_dens[[3]]$Stage)[j]], aes(x = absFC, fill=DEG=="DE")) +
  geom_density(aes(y=..scaled..), alpha = 0.4) +
  scale_fill_manual(values= c("FALSE"="grey", "TRUE"="#006600")) + 
  theme_classic() + 
  xlab("absolute(logFC)") +
  ylab("Density") +
  ggtitle(paste('Distribution of', names(fc_dens)[3], 'Parent DEG LogFC in', names(fc_dens)[j], sep=" ")) 
  
}

fcplots_all <- multiplot(densplots[[1]][[1]], densplots[[1]][[2]], densplots[[1]][[3]], 
                         densplots[[2]][[1]], densplots[[2]][[2]], densplots[[2]][[3]],
                         densplots[[3]][[1]], densplots[[3]][[2]], densplots[[3]][[3]], cols=3)




```


## Control Embryo-specific analyses: 

Subset just the 00% embryo exposure samples for control embryo-specific analyses: 

```{r}
ce <- zz[,zz$samples$exposure=="00"]
```

#### Filter control embryo samples: 
```{r}

#Create list of genes with more than 5 counts for at least 4 samples in each treatment group: 
d = list()
treat <- unique(ce$samples$trt)
head(treat)
length(treat)

for (i in 1:length(treat)) {
	a <- which(ce$samples$trt==treat[i])
	b <- colnames(ce$counts[,a])
	kp <- rowSums(ce$counts[,a] > 5) >=4 
	g <- which(kp==TRUE)
	d[[i]] <- g
}

#Subset control embryo subset by the genes identified above: 
nrow(ce$counts)
filt_genes <- unique(names(unlist(d, use.names=TRUE)))
length(filt_genes)
ce <- ce[filt_genes,]
nrow(ce$counts)

#Save filtered control embryo background genes:
write.table(filt_genes, file="~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180322_controlemb_no_outliers_backgroundlist_noouts.csv",
	col.names=FALSE, row.names=FALSE, sep="\t")

#Transform the control embryo subset by the same constant: 
ce_transform <- log2(ce$counts +8)

#Repeat the above to check that transformation is good with control embryo-specific subset (because there are far fewer samples in the set)
ce_ttrans <- t(ce_transform)
ce_ttrans <- as.data.frame(ce_ttrans)
ce_ttrans <- TreatNames_sub(ce_ttrans)
mv <- MeanVar(ce_ttrans)
mea <- as.vector(mv$mean)
sd <- as.vector(mv$stdev)

slope <- (coef(lm(sd~mea))[2])
print(slope)

#Normalization of control embryo subset: 
ce_mean_counts <- colMeans(ce_transform)
ce_norm_counts <- sweep(ce_transform, 2, colMeans(ce_transform))
ce_grandmean <- mean(ce_mean_counts)
ce_norm_counts <- ce_norm_counts + ce_grandmean

#Save normalized counts and samples for control embryo subset: 
ce_norm_counts <- as.data.frame(ce_norm_counts)
write.table(ce_norm_counts, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180305_controlemb_no_outlier_normcounts_noouts.csv", 
		col.names=TRUE, row.names=TRUE, sep=",")
write.table(ce$samples, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180305_controlemb_no_outlier_samplesinfo_noouts.csv", 
            col.names=TRUE, row.names=TRUE, sep=",") 
```

## Test for differential expression

#### Control embryo subset
```{r}
#Format the dataframe to run lm() for every gene:
ce$counts <- ce_norm_counts
ce.deg <- t(ce$counts)
ce.deg <- as.data.frame(ce.deg)
ce.deg <- TreatNames_sub(ce.deg)

#Test lm() on small subset of genes:
t <- dim(ce.deg)[2]
test <- ce.deg[,(t-10):t]
l <- lm(formula=test[,"Funhe2EKm042398"] ~ group*stage, data=test)
a <- anova(l)

#Set up data frame for storing p-values from lm():
g <- dim(ce.deg)[2]-5
genelist.ce <- colnames(ce.deg[,1:g])
cof.ce <- rownames(a)[1:3]
pdat.ce <- matrix(nrow=length(genelist.ce), ncol=length(cof.ce))
colnames(pdat.ce) <- cof.ce
rownames(pdat.ce) <- genelist.ce

#Run lm() for every gene:
for (i in 1:ncol(ce.deg[,1:g])) {
	g <- which(rownames(pdat.ce)==colnames(ce.deg)[i])
	l <- lm(formula=ce.deg[,i] ~ group*stage, data=ce.deg)
	a <- anova(l)
	p <- a$`Pr(>F)`[1:3]
	pdat.ce[g,] <- p 
}

#Save p-values
pdat.ce <- as.data.frame(pdat.ce)
names(pdat.ce) <- gsub(":", "_", names(pdat.ce))
write.table(pdat.ce, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180322_exp00_anova_unadj_pvalues_noouts.csv", 
		col.names=TRUE, row.names=TRUE, sep=",")

#Adjust for FDR:
fdr.ce <- data.frame(pdat.ce)
adj.fdr.ce <- setDT(fdr.ce, keep.rownames = TRUE)
colnames(adj.fdr.ce)[1] <- "Gene"
adj.fdr.ce <- adj.fdr.ce %>%
  gather(`group`, `stage`, `group_stage`,
         key="cof", value="pvals")
adj.fdr.ce$adj.pvals <- p.adjust(adj.fdr.ce$pvals, method="fdr")
deg.ce <- adj.fdr.ce[adj.fdr.ce$adj.pvals <= 0.05,]

##For control embryo subset: 
write.table(adj.fdr.ce, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180305_all_fdradj_pval_exp00_noouts.csv", col.names=TRUE, row.names=FALSE, sep=",")
##For control embryo subset: 
write.table(deg.ce, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180305_fdradj_005_deg_exp00_noouts.csv", col.names=TRUE, row.names=FALSE, sep=",")

##Write each DEG by coefficient for control emb exposure samples: 
effects = list()
cof <- unique(deg.ce$cof)
for (i in 1:length(cof)) {
  a <- which(cof[i] == deg.ce$cof)
  effects[[cof[i]]] <- deg.ce[a,]
  write.table(effects[[cof[i]]], paste("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180305_adjp005_exp00_",  names(effects[cof[i]]), "_noouts.csv", sep=""),
              col.names=TRUE, row.names=FALSE, sep=",")
}

##Repeat for control emb exposure samples: 
a <- effects$group
b <- effects$stage
c <- effects$group_stage
a2 <- a[!(a$Gene %in% c$Gene) & !(a$Gene %in% b$Gene),]
b2 <- b[!(b$Gene %in% c$Gene) & !(b$Gene %in% a$Gene),]
write.table(a2, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180305_adjp005_exp00_unique_group_noouts.csv", col.names=TRUE, row.names=FALSE, sep=",")
write.table(b2, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180305_adjp005_exp00_unique_stage_noouts.csv", col.names=TRUE, row.names=FALSE, sep=",")
write.table(c, "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180305_adjp005_exp00_unique_group_stage_noouts.csv", col.names=TRUE, row.names=FALSE, sep=",")

##Repeat for control emb exposure samples: 
ce.cof <- list("group"=ce[as.vector(a2$Gene),]$counts, "stage"=ce[as.vector(b2$Gene),]$counts, "group_stage"=ce[as.vector(c$Gene),]$counts)
trtnorm.ce <- list()
gnorm.ce <- list()
names(trtnorm.ce) <- names(ce.cof)
names(gnorm.ce) <- names(ce.cof)
tmv.ce <- list()
for (i in 1:length(ce.cof)) {
  tmv.ce[[i]] <- as.data.frame(t(ce.cof[[i]]))
  tmv.ce[[i]] <- TreatNames_sub(tmv.ce[[i]])
  tmv.ce[[i]] <- MeanVar(tmv.ce[[i]])
  tmv.ce[[i]] <- t(tmv.ce[[i]]$mean)
  tmv.ce[[i]] <- tmv.ce[[i]][,sort(colnames(tmv.ce[[i]]))]
  trtnorm.ce[[i]] <- as.data.frame(cbind(tmv.ce[[i]][,1:3]-tmv.ce[[i]][,1], tmv.ce[[i]][,4:6]-tmv.ce[[i]][,4]))
  gnorm.ce[[i]] <- as.data.frame(tmv.ce[[i]]-rowMeans(tmv.ce[[i]]))
  write.table(trtnorm.ce[[i]], paste("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180305_exp00_", names(ce.cof[i]), "_trtnorm.txt", sep=""), col.names=NA, row.names=TRUE, sep="\t")
  write.table(gnorm.ce[[i]], paste("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/180305_exp00_", names(ce.cof[i]), "_gnorm.txt", sep=""), col.names=NA, row.names=TRUE, sep="\t")
}

```

Repeat above for control emb exposure. 
Make background list of Uniprot accession ids: 

```{r}
library(readr)
bg_ce <- read_csv("Ranalysis/180305_controlemb_backgroundlist_noouts.csv", col_names = FALSE)
bg_ce <- as.vector(bg_ce$X1)
bg_ce_unip <- genemodels[genemodels$geneID %in% bg_ce,]$lib
bg_ce_unip <- bg_ce_unip[!is.na(bg_ce_unip)]
write.table(bg_ce_unip, file="~/Documents/NIEHS_LSU_UCD/rnaseq/david_results/180305_exp00_backgroundgenelist.txt", row.names=FALSE, col.names=FALSE, sep="\t", quote=FALSE)

```

Make cluster gene lists of Uniprot accession ids for control embryos:

```{r}
dir <- "~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/mev_heatmap_expression_tables"
files_list <- list.files(path = dir, pattern = "180306_")
files <- file.path(dir, files_list)
filenames <- gsub("180306_", "", files_list)
filenames <- gsub(".txt", "", filenames)

#Dump cluster gene lists into a list element
geneclusters <- list()
for (i in 1:length(files)) {
  geneclusters[[i]] <- read.csv(files[i], header=TRUE, sep = "\t")
  colnames(geneclusters[[i]])[2] <- "Gene"
  names(geneclusters)[i] <- filenames[i]
  geneclusters[[i]] <- as.vector(geneclusters[[i]]$Gene)
}

#Filter above genes by those with uniprot accession number: 
library(readxl)
genemodels <- as.data.frame(read_xlsx("~/Documents/NIEHS_LSU_UCD/rnaseq/Ranalysis/Gene.Models.Conservative.and.Liberal.xlsx"))
names(genemodels) <- c("geneID", "name", "cons", "lib")
unip <- list()

for (i in 1:length(geneclusters)){
  unip[[i]] <- genemodels[genemodels$geneID %in% geneclusters[[i]],]$lib
  unip[[i]] <- unip[[i]][!is.na(unip[[i]])]
  names(unip)[i] <- names(geneclusters)[i]
}
#Assign same length to all vectors, then run cbind: 
n <- max(lengths(unip))
for (i in 1:length(unip)) {
  length(unip[[i]]) <- n
}
david <- do.call(cbind, unip)
write.table(david, file="~/Documents/NIEHS_LSU_UCD/rnaseq/david_results/180306_exp00_clustergenelists.txt", row.names = FALSE, col.names = TRUE, sep="\t", quote=FALSE)

```
